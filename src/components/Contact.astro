---
import { getMessages, type Lang } from "../i18n/messages";

import { actions } from "astro:actions";
import Modal from "./Modal.astro";

const { lang = "es" } = Astro.props as { lang?: Lang };
const content = getMessages(lang);

const idFromHref = (href: string) =>
  href.startsWith("#") ? href.slice(1) : href;
---

<section
  id={idFromHref(content.nav.contact.href)}
  class="mx-auto max-w-6xl px-6 py-20"
>
  <h2 class="text-white text-3xl md:text-4xl font-semibold">
    {content.sections.contact.title}
  </h2>
  <p class="mt-3 text-white/75 max-w-2xl">
    {content.sections.contact.subtitle}
  </p>

  <!-- Formulario de contacto -->
  <form
    id="contact-form"
    method="post"
    class="mt-10 flex flex-col gap-y-6 max-w-xl mx-auto"
  >
    <div class="flex flex-col gap-2">
      <label
        for="email"
        class="text-sm font-semibold text-gray-700 dark:text-gray-200 ml-1"
      >
        {content.sections.contact.labelEmail}
      </label>
      <input
        type="email"
        name="email"
        id="email"
        placeholder={content.sections.contact.phEmail}
        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white transition-all duration-200 focus:ring-2 focus:ring-emerald-400 focus:border-transparent outline-none placeholder:text-gray-400"
        required
      />
      <span id="email-error" class="text-xs text-red-500 mt-1 hidden"></span>
    </div>

    <div class="flex flex-col gap-2">
      <label
        for="message"
        class="text-sm font-semibold text-gray-700 dark:text-gray-200 ml-1"
      >
        {content.sections.contact.labelMessage}
      </label>
      <textarea
        name="message"
        id="message"
        rows="4"
        placeholder={content.sections.contact.phMessage}
        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white transition-all duration-200 focus:ring-2 focus:ring-emerald-400 focus:border-transparent outline-none placeholder:text-gray-400 resize-none"
        required></textarea>
      <span id="message-error" class="text-xs text-red-500 mt-1 hidden"></span>
    </div>

    <button
      id="submit-btn"
      type="submit"
      class="mt-2 w-full sm:w-max px-8 py-4 bg-emerald-400 text-black font-bold rounded-lg shadow-lg shadow-emerald-400/20 hover:bg-emerald-500 hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200"
    >
      {content.sections.contact.ctaSubmit}
    </button>

    <script>
      import { actions, isInputError } from "astro:actions";

      const form = document.getElementById("contact-form") as HTMLFormElement;
      const btn = document.getElementById("submit-btn") as HTMLButtonElement;
      const modal = document.getElementById("success-modal") as HTMLDivElement;
      const modalCard = document.getElementById("modal-card") as HTMLDivElement;
      const closeBtn = document.getElementById(
        "close-modal",
      ) as HTMLButtonElement;
      const emailError = document.getElementById("email-error");
      const messageError = document.getElementById("message-error");

      function toggleModal(show: boolean) {
        if (show) {
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          // Delay mínimo para que la transición de Tailwind se note
          setTimeout(() => {
            modalCard.classList.remove("scale-95", "opacity-0");
            modalCard.classList.add("scale-100", "opacity-100");
          }, 10);
        } else {
          modalCard.classList.remove("scale-100", "opacity-100");
          modalCard.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            modal.classList.remove("flex");
            modal.classList.add("hidden");
          }, 300);
        }
      }

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 1. Limpiar errores previos
        [emailError, messageError].forEach((el) => {
          if (el) {
            el.innerText = "";
            el.classList.add("hidden");
          }
        });

        // UI Loading
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerHTML = `<span class="animate-pulse">Enviando...</span>`;

        const formData = new FormData(form);
        const { data, error } = await actions.contact(formData);

        // 2. Manejar Errores de Validación (Zod)
        if (error && isInputError(error)) {
          if (error.fields.email) {
            emailError!.innerText = error.fields.email[0];
            emailError!.classList.remove("hidden");
          }
          if (error.fields.message) {
            messageError!.innerText = error.fields.message[0];
            messageError!.classList.remove("hidden");
          }
          return;
        }

        // 3. Manejar Errores de Servidor (Tu handler)
        if (error) {
          alert(error.message);
          return;
        }

        if (data) {
          toggleModal(true);
          form.reset();
        }

        // Reset UI
        btn.disabled = false;
        btn.innerText = originalText;
      });

      closeBtn?.addEventListener("click", () => toggleModal(false));
    </script>
  </form>

  <div class="mt-8 flex flex-wrap gap-3">
    <a
      class="rounded-md bg-emerald-400/90 px-5 py-3 font-medium text-black hover:bg-emerald-400"
      href={content.sections.contact.whatsappHref}
      target="_blank"
      rel="noreferrer"
    >
      {content.sections.contact.ctaWhatsApp}
    </a>
    <a
      class="rounded-md border border-white/20 px-5 py-3 font-medium text-white hover:bg-white/10"
      href={content.sections.contact.emailHref}
    >
      {content.sections.contact.ctaEmail}
    </a>
    <a
      class="rounded-md border border-white/20 px-5 py-3 font-medium text-white hover:bg-white/10"
      href="https://mail.google.com/mail/?view=cm&to=software.vm.solutions@gmail.com"
      target="_blank"
      rel="noopener"
      title="Enviar mail usando Gmail web"
    >
      Gmail Web
    </a>
    <button
      class="rounded-md border border-white/20 px-5 py-3 font-medium text-white hover:bg-white/10"
      type="button"
      onclick="navigator.clipboard.writeText('software.vm.solutions@gmail.com');alert('Email copiado!')"
      style="background: none;"
    >
      Copiar Email
    </button>
  </div>
  <p class="text-xs text-white/50 mt-3">
    {
      lang === "es"
        ? "En computadoras, el botón “Email” abrirá tu app de correo predeterminada. Si prefieres usar Gmail Web, haz clic en “Gmail Web”."
        : 'On computers, the "Email" button will open your default email app. If you prefer to use Gmail Web, click on "Gmail Web".'
    }
  </p>
</section>

<Modal />
